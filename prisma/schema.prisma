// File Path: prisma/schema.prisma

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// --- Models ---

model User {
  id                      String    @id @default(uuid())
  clerkId                 String    @unique
  email                   String    @unique
  firstName               String?
  lastName                String?
  imageUrl                String?
  phone                   String?
  company                 String?
  location                String?
  bio                     String?
  plan                    String    @default("free")
  userType                String    @default("business")
  role                    UserRole  @default(USER)
  status                  UserStatus @default(ACTIVE)
  lastLoginAt             DateTime?
  loginCount              Int       @default(0)
  
  // Payment tracking
  paymentStatus           PaymentStatus @default(UNPAID)
  lastPaymentDate         DateTime?
  nextPaymentDue          DateTime?
  
  // Navigation permissions (JSON array of allowed routes)
  allowedNavigation       Json?     @default("[\"dashboard\",\"calendar\",\"vault\",\"analytics\",\"profile\",\"pricing\",\"settings\",\"support\"]")

  onboardingComplete      Boolean   @default(false)
  hasGeneratedFirstBatch  Boolean   @default(false)

  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  brandProfile            BrandProfile?
  influencerProfile       InfluencerProfile?
  posts                   Post[]
  generationBatches       GenerationBatch[]
  reminders               Reminder[]
  socialMediaAccounts     SocialMediaAccount[]
  notifications           Notification[]
  supportTickets          SupportTicket[]
  activityLogs            ActivityLog[]
  contentIdeas            ContentIdea[]
  contentTemplates        ContentTemplate[]
}

// FINALIZED MODEL: This is the single source of truth for the brand profile.
model BrandProfile {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])

  // Core brand identity fields
  brandName             String
  industry              String
  brandDescription      String
  brandVoiceDescription String
  primaryGoal           String
  doRules               String?
  dontRules             String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Post {
  id        String     @id @default(uuid())
  userId    String
  user      User       @relation(fields: [userId], references: [id])
  
  batchId   String?
  batch     GenerationBatch? @relation(fields: [batchId], references: [id])

  content   String
  caption   String?
  platform  String     @default("instagram")
  status    PostStatus @default(AWAITING_REVIEW)
  mediaUrl  String?

  hashtags  String[]   @default([])
  mentions  String[]   @default([])
  
  aiGenerated Boolean  @default(false)
  metadata    Json?    @default("{}")

  likes     Int        @default(0)
  comments  Int        @default(0)
  reach     Int        @default(0)

  scheduledAt DateTime?
  postedAt    DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model GenerationBatch {
  id      String        @id @default(uuid())
  userId  String
  user    User          @relation(fields: [userId], references: [id])
  
  status  BatchStatus   @default(PENDING)
  posts   Post[]
  ideas   ContentIdea[]

  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

model ContentIdea {
  id        String             @id @default(uuid())
  userId    String
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  batchId   String?
  batch     GenerationBatch?   @relation(fields: [batchId], references: [id])
  title     String
  content   String
  tags      String[]           @default([])
  status    ContentIdeaStatus  @default(DRAFT)
  metadata  Json?              @default("{}")
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
}

model ContentTemplate {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  description String?
  category    String
  structure   Json?    @default("{}")
  metadata    Json?    @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model JobQueue {
  id        String   @id @default(uuid())
  type      String
  payload   Json
  status    String   @default("pending")
  attempts  Int      @default(0)
  result    Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model InfluencerProfile {
  id            String   @id @default(uuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id])
  displayName   String
  niche         String
  bio           String
  contentStyle  String
  doRules       String?
  dontRules     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Reminder {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  title       String
  description String?
  category    String   @default("reminder")
  startsAt    DateTime
  endsAt      DateTime?
  allDay      Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SocialMediaAccount {
  id            String              @id @default(uuid())
  userId        String
  user          User                @relation(fields: [userId], references: [id])
  platform      SocialMediaPlatform
  platformUserId String
  username      String?
  displayName   String?
  profileImage  String?
  accessToken   String              // Should be encrypted in production
  refreshToken  String?             // For platforms that support refresh tokens
  tokenExpiresAt DateTime?
  isActive      Boolean             @default(true)
  lastSync      DateTime?
  followerCount Int?
  pageId        String?             // For Facebook Pages
  
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  
  analytics     SocialMediaAnalytics[]
  
  @@unique([userId, platform])
}

model SocialMediaAnalytics {
  id            String              @id @default(uuid())
  accountId     String
  account       SocialMediaAccount  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  // Analytics metrics
  followers     Int                 @default(0)
  following     Int                 @default(0)
  posts         Int                 @default(0)
  engagement    Float               @default(0)
  reach         Int                 @default(0)
  impressions   Int                 @default(0)
  
  // Period data (daily, weekly, monthly snapshots)
  period        AnalyticsPeriod     @default(DAILY)
  date          DateTime
  
  createdAt     DateTime            @default(now())
  
  @@unique([accountId, period, date])
}

model EmailOtp {
  id          String   @id @default(uuid())
  email       String   @unique
  otp         String
  expiresAt   DateTime
  attempts    Int      @default(0)
  sendCount   Int      @default(0)
  windowStart DateTime @default(now())
  lastSentAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}


// --- Enums ---

enum PostStatus {
  AWAITING_REVIEW
  IDEA_APPROVED
  AWAITING_MEDIA
  READY_TO_SCHEDULE
  SCHEDULED
  POSTED
  FAILED
}

enum ContentIdeaStatus {
  DRAFT
  READY
  SCHEDULED
  ARCHIVED
}

enum BatchStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum SocialMediaPlatform {
  INSTAGRAM
  FACEBOOK
  TWITTER
  LINKEDIN
  TIKTOK
  YOUTUBE
}

enum AnalyticsPeriod {
  DAILY
  WEEKLY
  MONTHLY
}

enum UserRole {
  USER
  ADMIN
  OWNER
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
  DELETED
}

enum NotificationType {
  SYSTEM
  ADMIN_MESSAGE
  ANNOUNCEMENT
  WARNING
  SUCCESS
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum PaymentStatus {
  PAID
  UNPAID
  OVERDUE
  CANCELLED
}

model Notification {
  id          String            @id @default(uuid())
  userId      String
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        NotificationType  @default(SYSTEM)
  title       String
  message     String
  isRead      Boolean           @default(false)
  actionUrl   String?
  createdBy   String?
  createdAt   DateTime          @default(now())
  readAt      DateTime?
}

model SupportTicket {
  id          String          @id @default(uuid())
  userId      String
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject     String
  description String
  category    String
  status      TicketStatus    @default(OPEN)
  priority    TicketPriority  @default(MEDIUM)
  adminNotes  String?
  resolvedAt  DateTime?
  messages    TicketMessage[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  @@index([userId, status])
  @@index([status, createdAt])
}

model TicketMessage {
  id          String        @id @default(uuid())
  ticketId    String
  ticket      SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  senderId    String
  senderName  String
  isAdmin     Boolean       @default(false)
  message     String
  createdAt   DateTime      @default(now())
  
  @@index([ticketId, createdAt])
}

model ActivityLog {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action      String
  description String?
  ipAddress   String?
  userAgent   String?
  metadata    Json?
  createdAt   DateTime @default(now())
  
  @@index([userId, createdAt])
}

model SystemMetrics {
  id                String   @id @default(uuid())
  date              DateTime @unique
  totalUsers        Int      @default(0)
  activeUsers       Int      @default(0)
  newUsers          Int      @default(0)
  totalPosts        Int      @default(0)
  postsGenerated    Int      @default(0)
  instagramUsers    Int      @default(0)
  facebookUsers     Int      @default(0)
  twitterUsers      Int      @default(0)
  linkedinUsers     Int      @default(0)
  freeUsers         Int      @default(0)
  proUsers          Int      @default(0)
  enterpriseUsers   Int      @default(0)
  createdAt         DateTime @default(now())
  
  @@index([date])
}
